<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="个人日记 nodejs学习。"><meta name="baidu-site-verification" content="7tp9tihrLG"><title>第七章 Job异步处理 | 秋过冬漫长天亮中</title><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=1.0.0"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">第七章 Job异步处理</h1><a id="logo" href="/.">秋过冬漫长天亮中</a><p class="description">没有比脚更长的路，走过去，前面是个天！</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">第七章 Job异步处理</h1><div class="post-meta">Nov 24, 2016<span> | </span><span class="category"><a href="/categories/play-framework框架/">play framework框架</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/11/24/第七章-Job异步处理/" href="/2016/11/24/第七章-Job异步处理/#comments" class="ds-thread-count"></a><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1Job实现"><span class="toc-text">7.1Job实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2Bootstrap-Job"><span class="toc-text">7.2Bootstrap Job</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3Scheduled-Job"><span class="toc-text">7.3Scheduled Job</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4Job的直接调用"><span class="toc-text">7.4Job的直接调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5本章小结"><span class="toc-text">7.5本章小结</span></a></li></ol></div></div><div class="post-content"><p>由于Play是Web应用框架，所以大部分的应用逻辑是由响应HTTP请求的控制器来完成的。但是有时候我们需要在HTTP请求之外执行一些应用逻辑操作，比如初始化工作，维护任务或者在不阻塞HTTP请求执行池的情况下运行一些时间花费较长的任务。这时就可以利用Play提供的Job来满足这些需求。</p>
<p>Job完全由框架管理，这意味着Play会管理所有的数据库连接，JPA实体管理器的同步以及事务。</p>
<p>补充：<br>Job就是需要在指定的时刻或者时间段内执行的任务，通常由作业调度程序来执行调度和管理。</p>
<h2 id="7-1Job实现"><a href="#7-1Job实现" class="headerlink" title="7.1Job实现"></a>7.1Job实现</h2><p>在Play中建立Job只需要继承play.jobs.Job类：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> jobs;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> play.jobs.*;</div><div class="line"> </div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyJob</span> <span class="keyword">extends</span> <span class="title">Job</span> </span>&#123;</div><div class="line">    </div><div class="line">    public void doJob() &#123;</div><div class="line">        <span class="comment">// 执行一些业务逻辑</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果希望创建具有返回值的Job，那么需要覆盖doJobWithResult()方法：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> jobs;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> play.jobs.*;</div><div class="line">  </div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">MyJob</span> <span class="keyword">extends</span> <span class="title">Job&lt;String&gt;</span> </span>&#123;</div><div class="line">    </div><div class="line">    public <span class="type">String</span> doJobWithResult() &#123;</div><div class="line">        <span class="comment">// 执行一些业务逻辑</span></div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上例自定义的Job覆盖了doJobWithResult()方法，并且方法的返回类型为String，事实上Job可以返回任何类型的值。</p>
<h2 id="7-2Bootstrap-Job"><a href="#7-2Bootstrap-Job" class="headerlink" title="7.2Bootstrap Job"></a>7.2Bootstrap Job</h2><p>7.2.1 应用启动#</p>
<p>Bootstrap Job，顾名思义就是在应用开始时运行的任务，只需要添加@OnApplicationStart注解就可以把当前Job设置为Bootstrap Job：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> play.jobs.*;</div><div class="line"> </div><div class="line"><span class="meta">@OnApplicationStart</span></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> <span class="keyword">extends</span> <span class="title">Job</span> </span>&#123;</div><div class="line">    </div><div class="line">    public void doJob() &#123;</div><div class="line">        <span class="keyword">if</span>(<span class="type">Page</span>.count() == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">new</span> <span class="type">Page</span>(<span class="string">"root"</span>).save();</div><div class="line">            <span class="type">Logger</span>.info(<span class="string">"A root page has been created."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>需要注意的是，Bootstrap Job不需要任何返回值。如果有多个带有@OnApplicationStart注解的Bootstrap Job，那么默认情况下这些Job会按照定义的先后顺序执行。当所有的Bootstrap Job执行完成之后，Web应用就处于等待阶段，等待处理那些即将到来的请求。<br>如果希望Web应用启动后，能够在执行Bootstrap Job的同时，又能很快地处理到来的请求，可以为@OnApplicationStart注解添加async=true属性：@OnApplicationStart(async=true)。这样应用程序开启后，Bootstrap Job就会作为后台程序异步执行了。不仅如此，所有的异步Job(async=true)也会在Web应用开启之后同时运行。</p>
<p>注意：<br>Play具有两种不同的工作模式：开发模式(DEV)和产品模式(PROD)，因此Job的启动时间也有略微差异。在DEV模式下，直到第一个HTTP请求到达时才会开启应用，且不会预先编译Java文件。如果在该模式下更改Java源文件可以立即生效，刷新浏览器即可查看修改后的结果。此外，应用还会在需要的时候自动重启；而在PROD模式下，应用会在服务器启动时同步开启，一旦应用开启就会自动编译所有的Java文件，之后不再重载任何文件(包括模板文件和配置文件)，所以如果有文件修改必须重启应用才能生效。所以DEV模式下Job会延迟启动。</p>
<p>7.2.2 应用停止#</p>
<p>Web应用停止或关闭的时候，常常也需要进行一些额外的操作，如进行数据的清理、日志的打印等。如果开发者需要这类任务调度操作，可以使用Play提供的@OnApplicationStop注解。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> play.jobs.*;</div><div class="line"> </div><div class="line"><span class="meta">@OnApplicationStop</span></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> <span class="keyword">extends</span> <span class="title">Job</span> </span>&#123;</div><div class="line"> </div><div class="line">    public void doJob() &#123;</div><div class="line">        <span class="type">Fixture</span>.deleteAll();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>用法非常简单，继承Job类之后，重写doJob()方法即可。</p>
<h2 id="7-3Scheduled-Job"><a href="#7-3Scheduled-Job" class="headerlink" title="7.3Scheduled Job"></a>7.3Scheduled Job</h2><p> Scheduled Job是指可以被框架周期性执行的任务，可以使用@Every注解指定时间间隔控制Scheduled Job运行，例如：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> play.jobs.*;</div><div class="line"> </div><div class="line"><span class="meta">@Every</span>(<span class="string">"1h"</span>)</div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> <span class="keyword">extends</span> <span class="title">Job</span> </span>&#123;</div><div class="line">    </div><div class="line">    public void doJob() &#123;</div><div class="line">        <span class="type">List</span>&lt;<span class="type">User</span>&gt; newUsers = <span class="type">User</span>.find(<span class="string">"newAccount = true"</span>).fetch();</div><div class="line">        <span class="keyword">for</span>(<span class="type">User</span> user : newUsers) &#123;</div><div class="line">            <span class="type">Notifier</span>.sayWelcome(user);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在实际开发中，@Every注解并不能够完全满足开发需求，比如有时候需要指定Scheduled Job在具体的某个时间点执行。这时候可以使用@On注解指定时间点来执行Job，例如：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> play.jobs.*;</div><div class="line"> </div><div class="line"><span class="comment">/** Fire at 12pm (noon) every day **/</span> </div><div class="line"><span class="meta">@On</span>(<span class="string">"0 0 12 * * ?"</span>)</div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> <span class="keyword">extends</span> <span class="title">Job</span> </span>&#123;</div><div class="line">    </div><div class="line">    public void doJob() &#123;</div><div class="line">        <span class="type">Logger</span>.info(<span class="string">"Maintenance job ..."</span>);</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div><div class="line">与<span class="type">Bootstrap</span> <span class="type">Job</span>一样，<span class="type">Scheduled</span> <span class="type">Job</span>也是不需要任何返回值的，即使返回了也会丢失。</div></pre></td></tr></table></figure></p>
<p>补充：<br>@On标签中使用的是Quartz库的CRON表达式。CRON表达式是由7个子表达式组成的字符串，每个子表达式都描述了单独的日程细节。这些子表达式用空格分隔，分别表示：</p>
<p>Seconds 秒<br>Minutes 分钟<br>Hours 小时<br>Day-of-Month 一个月中的某一天<br>Month 月<br>Day-of-Week 一周中的某一天<br>Year 年（可选）<br>具体CRON表达式的例子：”0 0 12 ? * WED”，表示“每周三的中午12：00”。</p>
<h2 id="7-4Job的直接调用"><a href="#7-4Job的直接调用" class="headerlink" title="7.4Job的直接调用"></a>7.4Job的直接调用</h2><p>Play的Job除了被框架自动调用外，也可以通过now()方法手动调用Job对象的实例，随时触发Job来执行指定任务。使用now()方法调用Job后，任务会立即执行：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encodeVideo</span><span class="params">(Long videoId)</span> </span>&#123;</div><div class="line">    <span class="keyword">new</span> VideoEncoder(videoId).now();</div><div class="line">    renderText(<span class="string">"Encoding started"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>now()方法的返回值是Promise对象，通过该值可以在结束后获得Job的执行结果。</p>
<h2 id="7-5本章小结"><a href="#7-5本章小结" class="headerlink" title="7.5本章小结"></a>7.5本章小结</h2><p>本章节主要介绍了Play框架的Job功能。作为Web应用，大部分业务逻辑由控制器负责完成，但是仍有部分任务，例如数据的初始化，定期的维护等时间开销较大的操作并不适合控制器去完成。对于类似功能，传统的实现方式是需要另外书写独立的程序进行维护。Job的价值就体现在能够无缝集成到Play应用当中，从而进一步提高了开发效率。Play针对不同的需求提供了各种形式的Job：Bootstrap Job在应用开始时执行；Scheduled Job会被框架周期性执行，本章最后还提到了如何直接在业务程序中调用Job。</p>
</div><div class="tags"><a href="/tags/play/">play</a></div><div class="post-nav"><a href="/2016/11/24/第八章-HTTP异步编程/" class="pre">第八章 HTTP异步编程</a><a href="/2016/11/24/第六章-域模型/" class="next">第六章 域模型</a></div><div data-thread-key="2016/11/24/第七章-Job异步处理/" data-title="第七章 Job异步处理" data-url="http://lisxweb.github.io/2016/11/24/第七章-Job异步处理/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/11/24/第七章-Job异步处理/" data-title="第七章 Job异步处理" data-url="http://lisxweb.github.io/2016/11/24/第七章-Job异步处理/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="widget"><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="请输入关键字..."/></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux服务器/">Linux服务器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MAC实用/">MAC实用</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/play-framework框架/">play framework框架</a><span class="category-list-count">8</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/Linux服务器/" style="font-size: 15px;">Linux服务器</a> <a href="/tags/play/" style="font-size: 15px;">play</a> <a href="/tags/MAC-Eclipse-快捷键/" style="font-size: 15px;">MAC Eclipse 快捷键</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-fei"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/11/24/第八章-HTTP异步编程/">第八章 HTTP异步编程</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/24/第七章-Job异步处理/">第七章 Job异步处理</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/24/第六章-域模型/">第六章 域模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/24/第五章-模板引擎/">第五章 模板引擎</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/23/第四章-控制层/">第四章 控制层</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/22/第三章-路由语法/">第三章 路由语法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/21/整理MAC下Eclipse的常用快捷键/">整理MAC下Eclipse的常用快捷键</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/21/Linux服务器增量备份脚步/">Linux服务器增量备份脚本</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/18/第二章-基础概念/">第二章 基础概念</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/17/第一章-绪论/">第一章 绪论</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-commt"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div></div><a id="totop" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |<a href="/atom.xml">订阅本站</a> |<span>联系博主：<a href="mailto:zhenggchaoo@gmail.com" target="_blank" class="fa fa-email"> </a><a href="http://weibo.com/zhengchaooo" target="_blank" class="fa fa-weibo"></a><a href="https://github.com/chaooo" target="_blank" class="fa fa-github"> </a></span></p><p><span> Copyright &copy;<a href="/." rel="nofollow">lisxweb</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span><span><a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> Theme </a>by<a rel="nofollow" target="_blank" href="https://github.com/chaooo"> Charles.</a></span></p></div></div></div><script>var duoshuoQuery = {short_name:'lisx'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    document.getElementsByTagName('body')[0].appendChild(ds);
})();
</script><script type="text/javascript" src="/js/search.json.js?v=1.0.0"></script></body></html>